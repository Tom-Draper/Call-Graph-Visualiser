<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Example</title>
    <style type="text/css">
      #mynetwork {
          width: 100%;
          height: 100%;
          margin: 0;
      }
      body {
        margin: 0;
      }
  </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script>
      const loadJSON = (callback) => {
        const xObj = new XMLHttpRequest()
        xObj.overrideMimeType('application/json')
        xObj.open('GET', './nodes.json', true)
        xObj.onreadystatechange = () => {
          if (xObj.readyState === 4 && xObj.status === 200) {
            callback(xObj.responseText)
          }
        }
        xObj.send(null)
      }

      const init = () => {
        loadJSON((response) => {
          const json = JSON.parse(response)
          onLoad(json);
        })
      }

      function isUpperCase(str) {
        return str === str.toUpperCase();
      }

      function getClass(func) {
        let parts = func.split('.')
        for (let part of parts) {
          if (part != null && part != '') {
            if (isUpperCase(part[0])) {
              return part
            }
          }
        }
        return null
      }

      function randomColour() {
        return "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0').toUpperCase();
      }

      function buildNextNode(id, label, func, groups) {
        let nextNode = null;
        let group = getClass(func)
        if (group != null) {
          nextNode = {'id': id, 'label': label, 'group': group}
          if (!(group in groups)) {
            groups[group] = {
              shape: 'circle',
              color: {
                border: 'black',
                background: randomColour(),
                highlight: {
                  border: 'yellow',
                  background: 'orange'
                }
              },
              fontColor: 'red',
              fontSize: 18
            }
          }
        } else {
            nextNode = {'id': id, 'label': label}
        }
        return nextNode
      }

      function onLoad(funcMap) {
        // Create nodes
        let nodeIds = {}
        let id = 0
        let groups = {}
        let n = []
        for (const func in funcMap) {
          // Add defined function as node
          let parts = func.split('.')
          let label = parts[parts.length-1]

          let nextNode = buildNextNode(id, label, func, groups)

          n.push(nextNode)
          nodeIds[func] = id
          id += 1

          // Add any new called functions as nodes
          for (const calledFunc of funcMap[func]) {
            if (!(calledFunc in nodeIds)) {
              let parts = calledFunc.split('.')
              let label = parts[parts.length-1]

              let nextNode = buildNextNode(id, label, calledFunc, groups)

              n.push(nextNode)
              nodeIds[calledFunc] = id
              id += 1
            }
          }
        }

        console.log(groups)

        var nodes = new vis.DataSet(n);

        let e = []
        // Connect nodes
        for (const func in funcMap) {
          // Add any new called functions as nodes
          for (const calledFunc of funcMap[func]) {
            e.push({'from': nodeIds[func], 'to': nodeIds[calledFunc]})
          }
        }
        var edges = new vis.DataSet(e)
        
        // console.log(n, e);

        //  nodes = new vis.DataSet([
        //     {id: 1, label: 'Node 1'},
        //     {id: 2, label: 'Node 2'},
        //     {id: 3, label: 'Node 3'},
        //     {id: 4, label: 'Node 4'},
        //     {id: 5, label: 'Node 5'}
        // ]);

        // // create an array with edges
        //  edges = new vis.DataSet([
        //     {from: 1, to: 3},
        //     {from: 1, to: 2},
        //     {from: 2, to: 4},
        //     {from: 2, to: 5}
        // ]);

        // create a network
        var container = document.getElementById('mynetwork')

        // provide the data in the vis format
        var data = {
          nodes: nodes,
          edges: edges,
        }
        var options = {
          layout: {improvedLayout: false}
        }

        // initialize your network!
        var network = new vis.Network(container, data, options)
        console.log('Finished')
        console.log(network);
      }
    </script>
    <style type="text/css">
      body,
      html,
      canvas {
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        position: absolute;
        margin: 0;
        overflow: hidden;
      }
      .node-label {
        position: absolute;
        pointer-events: none;
        color: black;
        z-index: 10;
      }
    </style>
  </head>
  <body onload="init()">
    hello
    <div id="mynetwork"></div>
  </body>
</html>
